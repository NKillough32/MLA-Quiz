<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V2 Bridge Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { color: #4CAF50; }
        .error { color: #F44336; }
        .warning { color: #FF9800; }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        #output {
            background: #fff;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            min-height: 200px;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>V2 Bridge Diagnostic Test</h1>
    
    <div class="test-section">
        <h3>Step 1: Check V1 App</h3>
        <button onclick="checkV1()">Check V1 App Status</button>
        <div id="v1-status"></div>
    </div>
    
    <div class="test-section">
        <h3>Step 2: Check V2 Managers</h3>
        <button onclick="checkV2()">Check V2 Managers</button>
        <div id="v2-status"></div>
    </div>
    
    <div class="test-section">
        <h3>Step 3: Test Calculator Bridge</h3>
        <button onclick="testBridge()">Test BMI Calculator Bridge</button>
        <div id="bridge-status"></div>
    </div>
    
    <div class="test-section">
        <h3>Console Output:</h3>
        <div id="output"></div>
    </div>

    <!-- Load V1 App -->
    <script src="/static/js/v1/app.js"></script>
    
    <script>
        const output = document.getElementById('output');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : type === 'warning' ? '⚠️' : 'ℹ️';
            output.textContent += `[${timestamp}] ${prefix} ${message}\n`;
        }
        
        function checkV1() {
            const status = document.getElementById('v1-status');
            status.innerHTML = '';
            
            log('Checking V1 app...', 'info');
            
            if (typeof window.quizApp !== 'undefined') {
                log('V1 app found: window.quizApp exists', 'success');
                status.innerHTML = '<span class="success">✅ V1 App Loaded</span>';
                
                // Check specific calculator methods
                const methods = ['getBMICalculator', 'getHASBLEDCalculator', 'getGCSCalculator'];
                methods.forEach(method => {
                    if (typeof window.quizApp[method] === 'function') {
                        log(`  - ${method}(): exists`, 'success');
                    } else {
                        log(`  - ${method}(): MISSING!`, 'error');
                    }
                });
            } else {
                log('V1 app NOT found', 'error');
                status.innerHTML = '<span class="error">❌ V1 App NOT Loaded</span>';
            }
        }
        
        function checkV2() {
            const status = document.getElementById('v2-status');
            status.innerHTML = '';
            
            log('Checking V2 managers...', 'info');
            
            const managers = [
                'calculatorManager',
                'eventBus',
                'uiManager',
                'initializeV2Integration'
            ];
            
            managers.forEach(name => {
                if (typeof window[name] !== 'undefined') {
                    log(`${name}: exists`, 'success');
                    status.innerHTML += `<div class="success">✅ ${name}</div>`;
                    
                    if (name === 'calculatorManager') {
                        const count = window.calculatorManager?.getCalculatorCount?.();
                        log(`  Registered calculators: ${count}`, 'info');
                    }
                } else {
                    log(`${name}: MISSING`, 'error');
                    status.innerHTML += `<div class="error">❌ ${name}</div>`;
                }
            });
        }
        
        function testBridge() {
            const status = document.getElementById('bridge-status');
            status.innerHTML = '';
            
            log('Testing calculator bridge...', 'info');
            
            if (!window.quizApp) {
                log('Cannot test bridge: V1 app not loaded', 'error');
                status.innerHTML = '<span class="error">❌ V1 App required</span>';
                return;
            }
            
            if (!window.calculatorManager) {
                log('Cannot test bridge: V2 Calculator Manager not loaded', 'error');
                status.innerHTML = '<span class="error">❌ V2 Calculator Manager required</span>';
                return;
            }
            
            try {
                // Get BMI calculator from V2
                const bmiCalc = window.calculatorManager.getCalculator('bmi');
                if (!bmiCalc) {
                    log('BMI calculator not found in V2 registry', 'error');
                    status.innerHTML = '<span class="error">❌ Calculator not registered</span>';
                    return;
                }
                
                log('BMI calculator found in V2 registry', 'success');
                log(`  Name: ${bmiCalc.name}`, 'info');
                log(`  Category: ${bmiCalc.category}`, 'info');
                
                // Try to get template
                log('Attempting to call getTemplate()...', 'info');
                const template = bmiCalc.getTemplate();
                
                if (template && template.length > 0) {
                    log(`Template generated successfully (${template.length} chars)`, 'success');
                    status.innerHTML = '<span class="success">✅ Bridge Working!</span>';
                    
                    // Show a preview
                    const preview = template.substring(0, 200) + '...';
                    log(`Template preview: ${preview}`, 'info');
                } else {
                    log('Template generation failed or empty', 'error');
                    status.innerHTML = '<span class="error">❌ Template generation failed</span>';
                }
                
            } catch (error) {
                log(`Bridge test failed: ${error.message}`, 'error');
                log(`Stack: ${error.stack}`, 'error');
                status.innerHTML = `<span class="error">❌ ${error.message}</span>`;
            }
        }
        
        // Auto-run checks on load
        window.addEventListener('load', () => {
            log('Page loaded, running automatic checks...', 'info');
            setTimeout(() => {
                checkV1();
                setTimeout(() => {
                    checkV2();
                }, 500);
            }, 500);
        });
    </script>
</body>
</html>
